<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css" integrity="sha384-B0vP5xmATw1+K9KRQjQERJvTumQW0nPEzvF6L/Z6nronJ3oUOFUFpCjEUQouq2+l" crossorigin="anonymous">
  <link href="/assets/css/style.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.7.2/styles/monokai.min.css">
  <link rel="apple-touch-icon" href="icon.png">
  <meta name="theme-color" content="#fafafa">
  <link href="https://fonts.googleapis.com/css?family=Asap" rel="stylesheet">
  <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>ActiveRecord::Querying | RailsDoc(β)</title>
<meta name="generator" content="Jekyll v3.9.3" />
<meta property="og:title" content="ActiveRecord::Querying" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Ruby on Rails API Documentation." />
<meta property="og:description" content="Ruby on Rails API Documentation." />
<link rel="canonical" href="https://railsdoc.github.io/6.1/classes/ActiveRecord/Querying.html" />
<meta property="og:url" content="https://railsdoc.github.io/6.1/classes/ActiveRecord/Querying.html" />
<meta property="og:site_name" content="RailsDoc(β)" />
<meta property="og:image" content="https://avatars.githubusercontent.com/u/4223" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:image" content="https://avatars.githubusercontent.com/u/4223" />
<meta property="twitter:title" content="ActiveRecord::Querying" />
<meta name="twitter:site" content="@" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebPage","description":"Ruby on Rails API Documentation.","headline":"ActiveRecord::Querying","image":"https://avatars.githubusercontent.com/u/4223","url":"https://railsdoc.github.io/6.1/classes/ActiveRecord/Querying.html"}</script>
<!-- End Jekyll SEO tag -->

  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134470810-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());

    gtag('config', 'UA-134470810-1');

    window.config = {
      rootPath: "/6.1/"
    }
  </script>
</head>
<body>
  <header class="navbar navbar-dark navbar-expand bg-dark flex-md-nowrap p-0 shadow sticky-header">
    <a class="navbar-brand col-sm-3 col-md-2 mr-0" href="/">RailsDoc(β)</a>
    <form class="w-100 d-none d-md-flex" action="/search" method="get">
      <input id="search-form" class="form-control form-control-dark" type="text" placeholder="Search" aria-label="Search" name="q">
    </form>

    <ul class="navbar-nav flex-row ml-md-auto d-none d-md-flex px-1">
      <li class="nav-item text-nowrap p-1">
        <div class="dropdown">
          <a class="dropdown-toggle nav-link" href="#" role="button" id="dropdownMenuLink" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
            v6.1
          </a>
          <div class="dropdown-menu dropdown-menu-md-right" aria-labelledby="dropdownMenuLink">
            <a class="dropdown-item" href="/">v7.0</a>
            
              
              <a class="dropdown-item" href="/6.1/">v6.1</a>
            
              
              <a class="dropdown-item" href="/6.0/">v6.0</a>
            
              
              <a class="dropdown-item" href="/5.2/">v5.2</a>
            
          </div>
        </div>
      </li>
      <li class="nav-item text-nowrap p-1">
        <a class="nav-link p-2" href="https://github.com/railsdoc/railsdoc.github.io">GitHub</a>
      </li>
    </ul>
  </header>

  <div class="container-fluid">
    <div class="row">
      <nav class="col-12 col-md-3 col-xl-2 d-none d-md-block bg-light sidebar-sticky">
        <div id="navigation" class="sidebar-content">
        </div>
      </nav>

      <div class="col-12 col-md-3 col-xl-2 toc-content-sticky">
        <div class="toc-content"><ul id="toc" class="section-nav">
<li class="toc-entry toc-h2"><a href="#methods">Methods</a></li>
<li class="toc-entry toc-h2"><a href="#instance-public-methods">Instance Public methods</a>
<ul>
<li class="toc-entry toc-h3"><a href="#method-i-count_by_sql">
            
              count_by_sql(sql)
            
          </a></li>
<li class="toc-entry toc-h3"><a href="#method-i-find_by_sql">
            
              find_by_sql(sql, binds = [], preparable: nil, &amp;block)
            
          </a></li>
</ul>
</li>
</ul></div>
      </div>

      <main role="main" class="col-12 col-md-9 col-xl-8 py-md-3 pl-md-4">
        <div class="main">
    <div class="banner">
        
            <span>Ruby on Rails 6.1.7</span><br />
        
        <div class="type">Module</div>
        <h1>
            ActiveRecord::Querying
            
        </h1>
        <ul class="files">
            
            <li><a href="../../files/activerecord/lib/active_record/querying_rb.html">activerecord/lib/active_record/querying.rb</a></li>
            
        </ul>
    </div>
    <div id="bodyContent">
        <div id="content">
  

  

  
  


  

  
    <h2 id="methods">Methods</h2>
    <ul>
      
        <li>
          <a href="#method-i-count_by_sql">count_by_sql</a>
        </li>
      
        <li>
          <a href="#method-i-find_by_sql">find_by_sql</a>
        </li>
      
    </ul>
  

  

  
    

    

    

    

    <!-- Methods -->
    
    
      <h2 id="instance-public-methods">Instance Public methods</h2>
      
        <div class="method">
          <h3 id="method-i-count_by_sql">
            
              count_by_sql(sql)
            
          </h3>

          
            <div class="description">
              <p>Returns the result of an SQL statement that should only include a COUNT(*) in the SELECT part. The use of this method should be restricted to complicated SQL queries that can&#39;t be executed using the <a href="Calculations.html"><code>ActiveRecord::Calculations</code></a> class methods. Look into those before using this method, as it could lock you into a specific database engine or require a code change to switch database engines.</p>

<pre><code>Product.count_by_sql &quot;SELECT COUNT(*) FROM sales s, customers c WHERE s.customer_id = c.id&quot;
# =&gt; 12
</code></pre>

<h4 id="method-i-count_by_sql-label-Parameters">Parameters</h4>
<ul><li>
<p><code>sql</code> - An SQL statement which should return a count query from the database, see the example above.</p>
</li></ul>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source:
                
              </p>
              <div id="method-i-count_by_sql_source">
                <pre><code class="ruby"><span class="ruby-comment"># File activerecord/lib/active_record/querying.rb, line 83</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">count_by_sql</span>(<span class="ruby-identifier">sql</span>)
  <span class="ruby-identifier">connection</span>.<span class="ruby-identifier">select_value</span>(<span class="ruby-identifier">sanitize_sql</span>(<span class="ruby-identifier">sql</span>), <span class="ruby-node">&quot;#{name} Count&quot;</span>).<span class="ruby-identifier">to_i</span>
<span class="ruby-keyword">end</span></code></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 id="method-i-find_by_sql">
            
              find_by_sql(sql, binds = [], preparable: nil, &amp;block)
            
          </h3>

          
            <div class="description">
              <p>Executes a custom SQL query against your database and returns all the results. The results will be returned as an array, with the requested columns encapsulated as attributes of the model you call this method from. For example, if you call <code>Product.find_by_sql</code>, then the results will be returned in a <code>Product</code> object with the attributes you specified in the SQL query.</p>

<p>If you call a complicated SQL query which spans multiple tables, the columns specified by the SELECT will be attributes of the model, whether or not they are columns of the corresponding table.</p>

<p>The <code>sql</code> parameter is a full SQL query as a string. It will be called as is; there will be no database agnostic conversions performed. This should be a last resort because using database-specific terms will lock you into using that particular database engine, or require you to change your call if you switch engines.</p>

<pre><code># A simple SQL query spanning multiple tables
Post.find_by_sql &quot;SELECT p.title, c.author FROM posts p, comments c WHERE p.id = c.post_id&quot;
# =&gt; [#&lt;Post:0x36bff9c @attributes={&quot;title&quot;=&gt;&quot;Ruby Meetup&quot;, &quot;author&quot;=&gt;&quot;Quentin&quot;}&gt;, ...]
</code></pre>

<p>You can use the same string replacement techniques as you can with <code>ActiveRecord::QueryMethods#where</code>:</p>

<pre><code>Post.find_by_sql [&quot;SELECT title FROM posts WHERE author = ? AND created &gt; ?&quot;, author_id, start_date]
Post.find_by_sql [&quot;SELECT body FROM comments WHERE author = :user_id OR approved_by = :user_id&quot;, { :user_id =&gt; user_id }]
</code></pre>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source:
                
              </p>
              <div id="method-i-find_by_sql_source">
                <pre><code class="ruby"><span class="ruby-comment"># File activerecord/lib/active_record/querying.rb, line 46</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">find_by_sql</span>(<span class="ruby-identifier">sql</span>, <span class="ruby-identifier">binds</span> = [], <span class="ruby-value">preparable:</span> <span class="ruby-keyword">nil</span>, <span class="ruby-operator">&amp;</span><span class="ruby-identifier">block</span>)
  <span class="ruby-identifier">result_set</span> = <span class="ruby-identifier">connection</span>.<span class="ruby-identifier">select_all</span>(<span class="ruby-identifier">sanitize_sql</span>(<span class="ruby-identifier">sql</span>), <span class="ruby-node">&quot;#{name} Load&quot;</span>, <span class="ruby-identifier">binds</span>, <span class="ruby-value">preparable:</span> <span class="ruby-identifier">preparable</span>)
  <span class="ruby-identifier">column_types</span> = <span class="ruby-identifier">result_set</span>.<span class="ruby-identifier">column_types</span>

  <span class="ruby-keyword">unless</span> <span class="ruby-identifier">column_types</span>.<span class="ruby-identifier">empty?</span>
    <span class="ruby-identifier">column_types</span> = <span class="ruby-identifier">column_types</span>.<span class="ruby-identifier">reject</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">k</span>, <span class="ruby-identifier">_</span><span class="ruby-operator">|</span> <span class="ruby-identifier">attribute_types</span>.<span class="ruby-identifier">key?</span>(<span class="ruby-identifier">k</span>) }
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">message_bus</span> = <span class="ruby-constant">ActiveSupport</span><span class="ruby-operator">::</span><span class="ruby-constant">Notifications</span>.<span class="ruby-identifier">instrumenter</span>

  <span class="ruby-identifier">payload</span> = {
    <span class="ruby-value">record_count:</span> <span class="ruby-identifier">result_set</span>.<span class="ruby-identifier">length</span>,
    <span class="ruby-value">class_name:</span> <span class="ruby-identifier">name</span>
  }

  <span class="ruby-identifier">message_bus</span>.<span class="ruby-identifier">instrument</span>(<span class="ruby-string">&quot;instantiation.active_record&quot;</span>, <span class="ruby-identifier">payload</span>) <span class="ruby-keyword">do</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">result_set</span>.<span class="ruby-identifier">includes_column?</span>(<span class="ruby-identifier">inheritance_column</span>)
      <span class="ruby-identifier">result_set</span>.<span class="ruby-identifier">map</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">record</span><span class="ruby-operator">|</span> <span class="ruby-identifier">instantiate</span>(<span class="ruby-identifier">record</span>, <span class="ruby-identifier">column_types</span>, <span class="ruby-operator">&amp;</span><span class="ruby-identifier">block</span>) }
    <span class="ruby-keyword">else</span>
      <span class="ruby-comment"># Instantiate a homogeneous set</span>
      <span class="ruby-identifier">result_set</span>.<span class="ruby-identifier">map</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">record</span><span class="ruby-operator">|</span> <span class="ruby-identifier">instantiate_instance_of</span>(<span class="ruby-keyword">self</span>, <span class="ruby-identifier">record</span>, <span class="ruby-identifier">column_types</span>, <span class="ruby-operator">&amp;</span><span class="ruby-identifier">block</span>) }
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></code></pre>
              </div>
            </div>
            
          </div>
        
      
    
  
</div>

    </div>
</div>

        <footer class="site-footer">
          <!-- <span class="site-footer-credits">This page was generated by <a href="https://pages.github.com">GitHub Pages</a>.</span> -->
        </footer>
      </main>
    </div>
  </div>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js" integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.min.js" integrity="sha384-+YQ4JLhjyBLPDQt//I+STsc9iw4uQqACwlvpslubQzn4u2UU2UFM80nGisd026JF" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/4.3.0/anchor.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.7.2/highlight.min.js"></script>
  <script src="/assets/js/app.js"></script>
  <script src="/assets/js/search.js"></script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css" integrity="sha384-xOolHFLEh07PJGoPkLv1IbcEPTNtaed2xpHsD9ESMhqIYd0nLMwNLD69Npy4HI+N" crossorigin="anonymous">
  <link href="/assets/css/style.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/monokai.min.css">
  <link rel="apple-touch-icon" href="icon.png">
  <meta name="theme-color" content="#fafafa">
  <link href="https://fonts.googleapis.com/css?family=Asap" rel="stylesheet">
  <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>ActiveRecord::DelegatedType | RailsDoc(Œ≤)</title>
<meta name="generator" content="Jekyll v3.9.3" />
<meta property="og:title" content="ActiveRecord::DelegatedType" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Ruby on Rails API Documentation." />
<meta property="og:description" content="Ruby on Rails API Documentation." />
<link rel="canonical" href="https://railsdoc.github.io/classes/ActiveRecord/DelegatedType.html" />
<meta property="og:url" content="https://railsdoc.github.io/classes/ActiveRecord/DelegatedType.html" />
<meta property="og:site_name" content="RailsDoc(Œ≤)" />
<meta property="og:image" content="https://avatars.githubusercontent.com/u/4223" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:image" content="https://avatars.githubusercontent.com/u/4223" />
<meta property="twitter:title" content="ActiveRecord::DelegatedType" />
<meta name="twitter:site" content="@" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebPage","description":"Ruby on Rails API Documentation.","headline":"ActiveRecord::DelegatedType","image":"https://avatars.githubusercontent.com/u/4223","url":"https://railsdoc.github.io/classes/ActiveRecord/DelegatedType.html"}</script>
<!-- End Jekyll SEO tag -->

  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134470810-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());

    gtag('config', 'UA-134470810-1');

    window.config = {
      rootPath: "/"
    }
  </script>
</head>
<body>
  <header class="navbar navbar-dark navbar-expand bg-dark flex-md-nowrap p-0 shadow sticky-header">
    <a class="navbar-brand col-sm-3 col-md-2 mr-0" href="/">RailsDoc(Œ≤)</a>
    <form class="w-100 d-none d-md-flex" action="/search" method="get">
      <input id="search-form" class="form-control form-control-dark" type="text" placeholder="Search" aria-label="Search" name="q">
    </form>

    <ul class="navbar-nav flex-row ml-md-auto d-none d-md-flex px-1">
      <li class="nav-item text-nowrap p-1">
        <div class="dropdown">
          <a class="dropdown-toggle nav-link" href="#" role="button" id="dropdownMenuLink" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
            v7.1
          </a>
          <div class="dropdown-menu dropdown-menu-md-right" aria-labelledby="dropdownMenuLink">
            
    
    
    
        <a class="dropdown-item" href="/">v7.1</a>
    

    
    
    
        <a class="dropdown-item" href="/7.0/">v7.0</a>
    

    
    
    
        <a class="dropdown-item" href="/6.1/">v6.1</a>
    

    
    
    
        <a class="dropdown-item" href="/6.0/">v6.0</a>
    

    
    
    
        <a class="dropdown-item" href="/5.2/">v5.2</a>
    


          </div>
        </div>
      </li>
      <li class="nav-item text-nowrap p-1">
        <a class="nav-link p-2" href="https://github.com/railsdoc/railsdoc.github.io">GitHub</a>
      </li>
    </ul>
  </header>

  <div class="container-fluid">
    <div class="row">
      <nav class="col-12 col-md-3 col-xl-2 d-none d-md-block bg-light sidebar-sticky">
        <div id="navigation" class="sidebar-content">
        </div>
      </nav>

      <div class="col-12 col-md-3 col-xl-2 toc-content-sticky">
        <div class="toc-content"><ul id="toc" class="section-nav">
<li class="toc-entry toc-h2"><a href="#module-ActiveRecord::DelegatedType-label-Sharing+behavior+with+concerns+and+controllers">Sharing behavior with concerns and controllers</a></li>
<li class="toc-entry toc-h2"><a href="#module-ActiveRecord::DelegatedType-label-Creating+new+records">Creating new records</a></li>
<li class="toc-entry toc-h2"><a href="#module-ActiveRecord::DelegatedType-label-Adding+further+delegation">Adding further delegation</a></li>
<li class="toc-entry toc-h2"><a href="#module-ActiveRecord::DelegatedType-label-Nested+Attributes">Nested Attributes</a></li>
<li class="toc-entry toc-h2"><a href="#methods">Methods</a></li>
<li class="toc-entry toc-h2"><a href="#instance-public-methods">Instance Public methods</a>
<ul>
<li class="toc-entry toc-h3"><a href="#method-i-delegated_type">
            
              delegated_type(role, types:, **options)
            
          </a></li>
<li class="toc-entry toc-h3"><a href="#method-i-delegated_type-label-Options">Options</a></li>
</ul>
</li>
</ul></div>
      </div>

      <main role="main" class="col-12 col-md-9 col-xl-8 py-md-3 pl-md-4">
        <div class="main">
    <div class="banner">
        
            <span>Ruby on Rails 7.1.0</span><br />
        
        <div class="type">Module</div>
        <h1>
            ActiveRecord::DelegatedType
            
        </h1>
        <ul class="files">
            
            <li><a href="../../files/activerecord/lib/active_record/delegated_type_rb.html">activerecord/lib/active_record/delegated_type.rb</a></li>
            
        </ul>
    </div>
    <div id="bodyContent">
        <div id="content">
  
    <div class="description">
      
<h1 id="module-ActiveRecord::DelegatedType-label-Delegated+types">Delegated types</h1>

<p><a href="../Class.html"><code>Class</code></a> hierarchies can map to relational database tables in many ways. Active Record, for example, offers purely abstract classes, where the superclass doesn‚Äôt persist any attributes, and single-table inheritance, where all attributes from all levels of the hierarchy are represented in a single table. Both have their places, but neither are without their drawbacks.</p>

<p>The problem with purely abstract classes is that all concrete subclasses must persist all the shared attributes themselves in their own tables (also known as class-table inheritance). This makes it hard to do queries across the hierarchy. For example, imagine you have the following hierarchy:</p>

<pre><code>Entry &lt; ApplicationRecord
Message &lt; Entry
Comment &lt; Entry
</code></pre>

<p>How do you show a feed that has both <code>Message</code> and <code>Comment</code> records, which can be easily paginated? Well, you can‚Äôt! Messages are backed by a messages table and comments by a comments table. You can‚Äôt pull from both tables at once and use a consistent OFFSET/LIMIT scheme.</p>

<p>You can get around the pagination problem by using single-table inheritance, but now you‚Äôre forced into a single mega table with all the attributes from all subclasses. No matter how divergent. If a Message has a subject, but the comment does not, well, now the comment does anyway! So STI works best when there‚Äôs little divergence between the subclasses and their attributes.</p>

<p>But there‚Äôs a third way: Delegated types. With this approach, the ‚Äúsuperclass‚Äù is a concrete class that is represented by its own table, where all the superclass attributes that are shared amongst all the ‚Äúsubclasses‚Äù are stored. And then each of the subclasses have their own individual tables for additional attributes that are particular to their implementation. This is similar to what‚Äôs called multi-table inheritance in Django, but instead of actual inheritance, this approach uses delegation to form the hierarchy and share responsibilities.</p>

<p>Let‚Äôs look at that entry/message/comment example using delegated types:</p>

<pre><code># Schema: entries[ id, account_id, creator_id, created_at, updated_at, entryable_type, entryable_id ]
class Entry &lt; ApplicationRecord
  belongs_to :account
  belongs_to :creator
  delegated_type :entryable, types: %w[ Message Comment ]
end

module Entryable
  extend ActiveSupport::Concern

  included do
    has_one :entry, as: :entryable, touch: true
  end
end

# Schema: messages[ id, subject, body ]
class Message &lt; ApplicationRecord
  include Entryable
end

# Schema: comments[ id, content ]
class Comment &lt; ApplicationRecord
  include Entryable
end
</code></pre>

<p>As you can see, neither <code>Message</code> nor <code>Comment</code> are meant to stand alone. Crucial metadata for both classes resides in the <code>Entry</code> ‚Äúsuperclass‚Äù. But the <code>Entry</code> absolutely can stand alone in terms of querying capacity in particular. You can now easily do things like:</p>

<pre><code>Account.find(1).entries.order(created_at: :desc).limit(50)
</code></pre>

<p>Which is exactly what you want when displaying both comments and messages together. The entry itself can be rendered as its delegated type easily, like so:</p>

<pre><code># entries/_entry.html.erb
&lt;%= render &quot;entries/entryables/#{entry.entryable_name}&quot;, entry: entry %&gt;

# entries/entryables/_message.html.erb
&lt;div class=&quot;message&quot;&gt;
  &lt;div class=&quot;subject&quot;&gt;&lt;%= entry.message.subject %&gt;&lt;/div&gt;
  &lt;p&gt;&lt;%= entry.message.body %&gt;&lt;/p&gt;
  &lt;i&gt;Posted on &lt;%= entry.created_at %&gt; by &lt;%= entry.creator.name %&gt;&lt;/i&gt;
&lt;/div&gt;

# entries/entryables/_comment.html.erb
&lt;div class=&quot;comment&quot;&gt;
  &lt;%= entry.creator.name %&gt; said: &lt;%= entry.comment.content %&gt;
&lt;/div&gt;
</code></pre>

<h2 id="module-ActiveRecord::DelegatedType-label-Sharing+behavior+with+concerns+and+controllers">Sharing behavior with concerns and controllers</h2>

<p>The entry ‚Äúsuperclass‚Äù also serves as a perfect place to put all that shared logic that applies to both messages and comments, and which acts primarily on the shared attributes. Imagine:</p>

<pre><code>class Entry &lt; ApplicationRecord
  include Eventable, Forwardable, Redeliverable
end
</code></pre>

<p>Which allows you to have controllers for things like <code>ForwardsController</code> and <code>RedeliverableController</code> that both act on entries, and thus provide the shared functionality to both messages and comments.</p>

<h2 id="module-ActiveRecord::DelegatedType-label-Creating+new+records">Creating new records</h2>

<p>You create a new record that uses delegated typing by creating the delegator and delegatee at the same time, like so:</p>

<pre><code>Entry.create! entryable: Comment.new(content: &quot;Hello!&quot;), creator: Current.user
</code></pre>

<p>If you need more complicated composition, or you need to perform dependent validation, you should build a factory method or class to take care of the complicated needs. This could be as simple as:</p>

<pre><code>class Entry &lt; ApplicationRecord
  def self.create_with_comment(content, creator: Current.user)
    create! entryable: Comment.new(content: content), creator: creator
  end
end
</code></pre>

<h2 id="module-ActiveRecord::DelegatedType-label-Adding+further+delegation">Adding further delegation</h2>

<p>The delegated type shouldn‚Äôt just answer the question of what the underlying class is called. In fact, that‚Äôs an anti-pattern most of the time. The reason you‚Äôre building this hierarchy is to take advantage of polymorphism. So here‚Äôs a simple example of that:</p>

<pre><code>class Entry &lt; ApplicationRecord
  delegated_type :entryable, types: %w[ Message Comment ]
  delegate :title, to: :entryable
end

class Message &lt; ApplicationRecord
  def title
    subject
  end
end

class Comment &lt; ApplicationRecord
  def title
    content.truncate(20)
  end
end
</code></pre>

<p>Now you can list a bunch of entries, call <code>Entry#title</code>, and polymorphism will provide you with the answer.</p>

<h2 id="module-ActiveRecord::DelegatedType-label-Nested+Attributes">Nested <a href="Attributes.html"><code>Attributes</code></a></h2>

<p>Enabling nested attributes on a <a href="DelegatedType.html#method-i-delegated_type"><code>delegated_type</code></a> association allows you to create the entry and message in one go:</p>

<pre><code>class Entry &lt; ApplicationRecord
  delegated_type :entryable, types: %w[ Message Comment ]
  accepts_nested_attributes_for :entryable
end

params = { entry: { entryable_type: &#39;Message&#39;, entryable_attributes: { subject: &#39;Smiling&#39; } } }
entry = Entry.create(params[:entry])
entry.entryable.id # =&gt; 2
entry.entryable.subject # =&gt; &#39;Smiling&#39;
</code></pre>

    </div>
  

  

  
  


  

  
    <h2 id="methods">Methods</h2>
    <ul>
      
        <li>
          <a href="#method-i-delegated_type">delegated_type</a>
        </li>
      
    </ul>
  

  

  
    

    

    

    

    <!-- Methods -->
    
    
      <h2 id="instance-public-methods">Instance Public methods</h2>
      
        <div class="method">
          <h3 id="method-i-delegated_type">
            
              delegated_type(role, types:, **options)
            
          </h3>

          
            <div class="description">
              <p>Defines this as a class that‚Äôll delegate its type for the passed <code>role</code> to the class references in <code>types</code>. That‚Äôll create a polymorphic <code>belongs_to</code> relationship to that <code>role</code>, and it‚Äôll add all the delegated type convenience methods:</p>

<pre><code>class Entry &lt; ApplicationRecord
  delegated_type :entryable, types: %w[ Message Comment ], dependent: :destroy
end

Entry#entryable_class # =&gt; +Message+ or +Comment+
Entry#entryable_name  # =&gt; &quot;message&quot; or &quot;comment&quot;
Entry.messages        # =&gt; Entry.where(entryable_type: &quot;Message&quot;)
Entry#message?        # =&gt; true when entryable_type == &quot;Message&quot;
Entry#message         # =&gt; returns the message record, when entryable_type == &quot;Message&quot;, otherwise nil
Entry#message_id      # =&gt; returns entryable_id, when entryable_type == &quot;Message&quot;, otherwise nil
Entry.comments        # =&gt; Entry.where(entryable_type: &quot;Comment&quot;)
Entry#comment?        # =&gt; true when entryable_type == &quot;Comment&quot;
Entry#comment         # =&gt; returns the comment record, when entryable_type == &quot;Comment&quot;, otherwise nil
Entry#comment_id      # =&gt; returns entryable_id, when entryable_type == &quot;Comment&quot;, otherwise nil
</code></pre>

<p>You can also declare namespaced types:</p>

<pre><code>class Entry &lt; ApplicationRecord
  delegated_type :entryable, types: %w[ Message Comment Access::NoticeMessage ], dependent: :destroy
end

Entry.access_notice_messages
entry.access_notice_message
entry.access_notice_message?
</code></pre>

<h3 id="method-i-delegated_type-label-Options">Options</h3>

<p>The <code>options</code> are passed directly to the <code>belongs_to</code> call, so this is where you declare <code>dependent</code> etc. The following options can be included to specialize the behavior of the delegated type convenience methods.</p>
<dl class="rdoc-list label-list"><dt>:foreign_key
<dd>
<p>Specify the foreign key used for the convenience methods. By default this is guessed to be the passed <code>role</code> with an ‚Äú_id‚Äù suffix. So a class that defines a <code>delegated_type :entryable, types: %w[ Message Comment ]</code> association will use ‚Äúentryable_id‚Äù as the default <code>:foreign_key</code>.</p>
</dd><dt>:foreign_type
<dd>
<p>Specify the column used to store the associated object‚Äôs type. By default this is inferred to be the passed <code>role</code> with a ‚Äú_type‚Äù suffix. A class that defines a <code>delegated_type :entryable, types: %w[ Message Comment ]</code> association will use ‚Äúentryable_type‚Äù as the default <code>:foreign_type</code>.</p>
</dd><dt>:primary_key
<dd>
<p>Specify the method that returns the primary key of associated object used for the convenience methods. By default this is <code>id</code>.</p>
</dd></dl>

<p>Option examples:</p>

<pre><code>class Entry &lt; ApplicationRecord
  delegated_type :entryable, types: %w[ Message Comment ], primary_key: :uuid, foreign_key: :entryable_uuid
end

Entry#message_uuid      # =&gt; returns entryable_uuid, when entryable_type == &quot;Message&quot;, otherwise nil
Entry#comment_uuid      # =&gt; returns entryable_uuid, when entryable_type == &quot;Comment&quot;, otherwise nil
</code></pre>
            </div>
          

          

          

          
          
            <details class="method__source">
              <summary>
                <span class="label">üìù Source code</span>
              </summary>

              <pre><code class="ruby"># File activerecord/lib/active_record/delegated_type.rb, line 211
    def delegated_type(role, types:, **options)
      belongs_to role, options.delete(:scope), **options.merge(polymorphic: true)
      define_delegated_type_methods role, types: types, options: options
    end</code></pre>
              
                <a href="https://github.com/rails/rails/blob/d39db5d1891f7509cde2efc425c9d69bbb77e670/activerecord/lib/active_record/delegated_type.rb#L211" target="_blank" class="github_url">üîé See on GitHub</a>
              
            </details>
          
        </div>
        
      
    
  
</div>

    </div>
</div>

        <footer class="site-footer">
          <!-- <span class="site-footer-credits">This page was generated by <a href="https://pages.github.com">GitHub Pages</a>.</span> -->
        </footer>
      </main>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-Fy6S3B9q64WdZWQUiU+q4/2Lc9npb8tCaSX9FK7E8HnRr0Jz8D6OP9dO5Vg3Q9ct" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/4.3.1/anchor.min.js" integrity="sha512-zPB79j2C+3sFS9zcA3vg/z6bVKzJVEyu9pY5w89akQRys76zpAT2t6S3wZKla3QQ14O5l/Yt0RUQ/DHXx82Y5g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
  <script src="/assets/js/app.js"></script>
  <script src="/assets/js/search.js"></script>
</body>
</html>

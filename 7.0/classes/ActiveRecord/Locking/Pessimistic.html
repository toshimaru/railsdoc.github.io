<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css" integrity="sha384-xOolHFLEh07PJGoPkLv1IbcEPTNtaed2xpHsD9ESMhqIYd0nLMwNLD69Npy4HI+N" crossorigin="anonymous">
  <link href="/assets/css/style.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/monokai.min.css">
  <link rel="apple-touch-icon" href="icon.png">
  <meta name="theme-color" content="#fafafa">
  <link href="https://fonts.googleapis.com/css?family=Asap" rel="stylesheet">
  <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>ActiveRecord::Locking::Pessimistic | RailsDoc(β)</title>
<meta name="generator" content="Jekyll v3.9.5" />
<meta property="og:title" content="ActiveRecord::Locking::Pessimistic" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Ruby on Rails API Documentation." />
<meta property="og:description" content="Ruby on Rails API Documentation." />
<link rel="canonical" href="https://railsdoc.github.io/7.0/classes/ActiveRecord/Locking/Pessimistic.html" />
<meta property="og:url" content="https://railsdoc.github.io/7.0/classes/ActiveRecord/Locking/Pessimistic.html" />
<meta property="og:site_name" content="RailsDoc(β)" />
<meta property="og:image" content="https://avatars.githubusercontent.com/u/4223" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:image" content="https://avatars.githubusercontent.com/u/4223" />
<meta property="twitter:title" content="ActiveRecord::Locking::Pessimistic" />
<meta name="twitter:site" content="@" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebPage","description":"Ruby on Rails API Documentation.","headline":"ActiveRecord::Locking::Pessimistic","image":"https://avatars.githubusercontent.com/u/4223","url":"https://railsdoc.github.io/7.0/classes/ActiveRecord/Locking/Pessimistic.html"}</script>
<!-- End Jekyll SEO tag -->

  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134470810-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());

    gtag('config', 'UA-134470810-1');

    window.config = {
      rootPath: "/7.0/"
    }
  </script>
</head>
<body>
  <header class="navbar navbar-dark navbar-expand bg-dark flex-md-nowrap p-0 shadow sticky-header">
    <a class="navbar-brand col-sm-3 col-md-2 mr-0" href="/">RailsDoc(β)</a>
    <form class="w-100 d-none d-md-flex" action="/search" method="get">
      <input id="search-form" class="form-control form-control-dark" type="text" placeholder="Search" aria-label="Search" name="q">
    </form>

    <ul class="navbar-nav flex-row ml-md-auto d-none d-md-flex px-1">
      <li class="nav-item text-nowrap p-1">
        <div class="dropdown">
          <a class="dropdown-toggle nav-link" href="#" role="button" id="dropdownMenuLink" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
            v7.0
          </a>
          <div class="dropdown-menu dropdown-menu-md-right" aria-labelledby="dropdownMenuLink">
            
    
    
    
        <a class="dropdown-item" href="/">v7.1</a>
    

    
    
    
        <a class="dropdown-item" href="/7.0/">v7.0</a>
    

    
    
    
        <a class="dropdown-item" href="/6.1/">v6.1</a>
    

    
    
    
        <a class="dropdown-item" href="/6.0/">v6.0</a>
    

    
    
    
        <a class="dropdown-item" href="/5.2/">v5.2</a>
    


          </div>
        </div>
      </li>
      <li class="nav-item text-nowrap p-1">
        <a class="nav-link p-2" href="https://github.com/railsdoc/railsdoc.github.io">GitHub</a>
      </li>
    </ul>
  </header>

  <div class="container-fluid">
    <div class="row">
      <nav class="col-12 col-md-3 col-xl-2 d-none d-md-block bg-light sidebar-sticky">
        <div id="navigation" class="sidebar-content">
        </div>
      </nav>

      <div class="col-12 col-md-3 col-xl-2 toc-content-sticky">
        <div class="toc-content"><ul id="toc" class="section-nav">
<li class="toc-entry toc-h2"><a href="#methods">Methods</a></li>
<li class="toc-entry toc-h2"><a href="#instance-public-methods">Instance Public methods</a>
<ul>
<li class="toc-entry toc-h3"><a href="#method-i-lock-21">
            
              lock!(lock = true)
            
          </a></li>
<li class="toc-entry toc-h3"><a href="#method-i-with_lock">
            
              with_lock(*args)
            
          </a></li>
</ul>
</li>
</ul></div>
      </div>

      <main role="main" class="col-12 col-md-9 col-xl-8 py-md-3 pl-md-4">
        <div class="main">
    <div class="banner">
        
            <span>Ruby on Rails 7.0.8</span><br />
        
        <div class="type">Module</div>
        <h1>
            ActiveRecord::Locking::Pessimistic
            
        </h1>
        <ul class="files">
            
            <li><a href="../../../files/activerecord/lib/active_record/locking/pessimistic_rb.html">activerecord/lib/active_record/locking/pessimistic.rb</a></li>
            
        </ul>
    </div>
    <div id="bodyContent">
        <div id="content">
  
    <div class="description">
      
<p><a href="Pessimistic.html"><code>Locking::Pessimistic</code></a> provides support for row-level locking using SELECT … FOR UPDATE and other lock types.</p>

<p>Chain <code>ActiveRecord::Base#find</code> to <a href="../QueryMethods.html#method-i-lock"><code>ActiveRecord::QueryMethods#lock</code></a> to obtain an exclusive lock on the selected rows:</p>

<pre><code># select * from accounts where id=1 for update
Account.lock.find(1)
</code></pre>

<p>Call <code>lock(&#39;some locking clause&#39;)</code> to use a database-specific locking clause of your own such as ‘LOCK IN SHARE MODE’ or ‘FOR UPDATE NOWAIT’. Example:</p>

<pre><code>Account.transaction do
  # select * from accounts where name = &#39;shugo&#39; limit 1 for update nowait
  shugo = Account.lock(&quot;FOR UPDATE NOWAIT&quot;).find_by(name: &quot;shugo&quot;)
  yuko = Account.lock(&quot;FOR UPDATE NOWAIT&quot;).find_by(name: &quot;yuko&quot;)
  shugo.balance -= 100
  shugo.save!
  yuko.balance += 100
  yuko.save!
end
</code></pre>

<p>You can also use <code>ActiveRecord::Base#lock!</code> method to lock one record by id. This may be better if you don’t need to lock every row. Example:</p>

<pre><code>Account.transaction do
  # select * from accounts where ...
  accounts = Account.where(...)
  account1 = accounts.detect { |account| ... }
  account2 = accounts.detect { |account| ... }
  # select * from accounts where id=? for update
  account1.lock!
  account2.lock!
  account1.balance -= 100
  account1.save!
  account2.balance += 100
  account2.save!
end
</code></pre>

<p>You can start a transaction and acquire the lock in one go by calling <code>with_lock</code> with a block. The block is called from within a transaction, the object is already locked. Example:</p>

<pre><code>account = Account.first
account.with_lock do
  # This block is called within a transaction,
  # account is already locked.
  account.balance -= 100
  account.save!
end
</code></pre>

<p>Database-specific information on row locking:</p>
<dl class="rdoc-list label-list"><dt>MySQL
<dd>
<p><a href="https://dev.mysql.com/doc/refman/en/innodb-locking-reads.html">dev.mysql.com/doc/refman/en/innodb-locking-reads.html</a></p>
</dd><dt>PostgreSQL
<dd>
<p><a href="https://www.postgresql.org/docs/current/interactive/sql-select.html#SQL-FOR-UPDATE-SHARE">www.postgresql.org/docs/current/interactive/sql-select.html#SQL-FOR-UPDATE-SHARE</a></p>
</dd></dl>

    </div>
  

  

  
  


  

  
    <h2 id="methods">Methods</h2>
    <ul>
      
        <li>
          <a href="#method-i-lock-21">lock!</a>
        </li>
      
        <li>
          <a href="#method-i-with_lock">with_lock</a>
        </li>
      
    </ul>
  

  

  
    

    

    

    

    <!-- Methods -->
    
    
      <h2 id="instance-public-methods">Instance Public methods</h2>
      
        <div class="method">
          <h3 id="method-i-lock-21">
            
              lock!(lock = true)
            
          </h3>

          
            <div class="description">
              <p>Obtain a row lock on this record. Reloads the record to obtain the requested lock. Pass an SQL locking clause to append the end of the SELECT statement or pass true for “FOR UPDATE” (the default, an exclusive row lock). Returns the locked record.</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source:
                
              </p>
              <div id="method-i-lock-21_source">
                <pre><code class="ruby"><span class="ruby-comment"># File activerecord/lib/active_record/locking/pessimistic.rb, line 67</span>
      <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">lock!</span>(<span class="ruby-identifier">lock</span> = <span class="ruby-keyword">true</span>)
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">persisted?</span>
          <span class="ruby-keyword">if</span> <span class="ruby-identifier">has_changes_to_save?</span>
            <span class="ruby-identifier">raise</span>(<span class="ruby-identifier">&lt;&lt;-MSG</span>.<span class="ruby-identifier">squish</span>)
<span class="ruby-value">              Locking a record with unpersisted changes is not supported. Use
              `save` to persist the changes, or `reload` to discard them
              explicitly.
</span><span class="ruby-identifier">            MSG</span>
          <span class="ruby-keyword">end</span>

          <span class="ruby-identifier">reload</span>(<span class="ruby-value">lock:</span> <span class="ruby-identifier">lock</span>)
        <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">self</span>
      <span class="ruby-keyword">end</span></code></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 id="method-i-with_lock">
            
              with_lock(*args)
            
          </h3>

          
            <div class="description">
              <p>Wraps the passed block in a transaction, locking the object before yielding. You can pass the SQL locking clause as an optional argument (see <a href="Pessimistic.html#method-i-lock-21"><code>lock!</code></a>).</p>

<p>You can also pass options like <code>requires_new:</code>, <code>isolation:</code>, and <code>joinable:</code> to the wrapping transaction (see <a href="../ConnectionAdapters/DatabaseStatements.html#method-i-transaction"><code>ActiveRecord::ConnectionAdapters::DatabaseStatements#transaction</code></a>).</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source:
                
              </p>
              <div id="method-i-with_lock_source">
                <pre><code class="ruby"><span class="ruby-comment"># File activerecord/lib/active_record/locking/pessimistic.rb, line 89</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">with_lock</span>(<span class="ruby-operator">*</span><span class="ruby-identifier">args</span>)
  <span class="ruby-identifier">transaction_opts</span> = <span class="ruby-identifier">args</span>.<span class="ruby-identifier">extract_options!</span>
  <span class="ruby-identifier">lock</span> = <span class="ruby-identifier">args</span>.<span class="ruby-identifier">present?</span> <span class="ruby-operator">?</span> <span class="ruby-identifier">args</span>.<span class="ruby-identifier">first</span> <span class="ruby-operator">:</span> <span class="ruby-keyword">true</span>
  <span class="ruby-identifier">transaction</span>(<span class="ruby-operator">**</span><span class="ruby-identifier">transaction_opts</span>) <span class="ruby-keyword">do</span>
    <span class="ruby-identifier">lock!</span>(<span class="ruby-identifier">lock</span>)
    <span class="ruby-keyword">yield</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></code></pre>
              </div>
            </div>
            
          </div>
        
      
    
  
</div>

    </div>
</div>

        <footer class="site-footer">
          <!-- <span class="site-footer-credits">This page was generated by <a href="https://pages.github.com">GitHub Pages</a>.</span> -->
        </footer>
      </main>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-Fy6S3B9q64WdZWQUiU+q4/2Lc9npb8tCaSX9FK7E8HnRr0Jz8D6OP9dO5Vg3Q9ct" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/4.3.1/anchor.min.js" integrity="sha512-zPB79j2C+3sFS9zcA3vg/z6bVKzJVEyu9pY5w89akQRys76zpAT2t6S3wZKla3QQ14O5l/Yt0RUQ/DHXx82Y5g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
  <script src="/assets/js/app.js"></script>
  <script src="/assets/js/search.js"></script>
</body>
</html>
